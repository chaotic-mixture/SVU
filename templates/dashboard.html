{% extends "base.html" %}

{% block title %}数据库管理终端 - SVU管理系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">数据库管理终端</h1>
            
            <!-- 统计卡片 -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">货币</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.currency }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">加密货币</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.crypto }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-coins fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">商品</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.commodity }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-box fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">SVU值</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">计算中...</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calculator fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 汇率计算器 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">汇率计算器</h5>
                        </div>
                        <div class="card-body">
                            <form id="exchangeForm">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="amount">金额</label>
                                            <input type="number" class="form-control" id="amount" value="1" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="fromCurrency">基准货币</label>
                                            <select class="form-control" id="fromCurrency">
                                                {% for item in items %}
                                                <option value="{{ item.symbol }}">{{ item.name }} ({{ item.symbol }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="toCurrencies">目标货币</label>
                                            <select class="form-control" id="toCurrencies" multiple size="5">
                                                {% for item in items %}
                                                <option value="{{ item.symbol }}">{{ item.name }} ({{ item.symbol }})</option>
                                                {% endfor %}
                                            </select>
                                            <small class="form-text text-muted">按住Ctrl键可多选</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>&nbsp;</label>
                                            <button type="submit" class="btn btn-primary btn-block">计算汇率</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="mt-3" id="exchangeResult"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 历史走势图 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">历史走势</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- 基准计价物（单选） -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="baseCurrency">基准计价物</label>
                                        <select class="form-control" id="baseCurrency">
                                            {% for item in items %}
                                            <option value="{{ item.symbol }}">{{ item.name }} ({{ item.symbol }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <!-- 目标计价物（多选） -->
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="chartCurrency">目标计价物（可多选）</label>
                                        <select class="form-control" id="chartCurrency" multiple size="5">
                                            {% for item in items %}
                                            <option value="{{ item.symbol }}">{{ item.name }} ({{ item.symbol }})</option>
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">按住Ctrl键可多选</small>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" id="selectAll">全选</button>
                                        <button class="btn btn-sm btn-outline-secondary" id="deselectAll">取消全选</button>
                                    </div>
                                </div>
                            </div>
                            <!-- 时间周期按钮 -->
                            <div class="row mt-2">
                                <div class="col-12">
                                    <div class="btn-group" role="group" aria-label="周期选择">
                                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="1d">天</button>
                                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="1w">周</button>
                                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="1m">月</button>
                                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="1y">年</button>
                                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="5y" disabled>5年</button>
                                    </div>
                                </div>
                            </div>
                            <!-- 图表 -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <canvas id="summaryChart" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 统计信息 -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="row" id="statsContainer"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据操作区域 -->
            <div class="row">
                <!-- 数据表格 -->
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">数据列表</h6>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addItemModal">
                                    <i class="fas fa-plus"></i> 添加数据
                                </button>
                                <button type="button" class="btn btn-success" id="refreshData">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="itemsTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>名称</th>
                                            <th>代码</th>
                                            <th>类型</th>
                                            <th>市场类型</th>
                                            <th>最新价格</th>
                                            <th>更新时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items %}
                                        <tr>
                                            <td>{{ item.name }}</td>
                                            <td>{{ item.symbol }}</td>
                                            <td>{{ item.type }}</td>
                                            <td>{{ item.market_type }}</td>
                                            <td class="price" data-id="{{ item.id }}">加载中...</td>
                                            <td class="update-time" data-id="{{ item.id }}">-</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-info view-data" data-id="{{ item.id }}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-warning update-price" data-id="{{ item.id }}">
                                                        <i class="fas fa-sync-alt"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-item" data-id="{{ item.id }}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 实时数据监控 -->
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">实时数据监控</h6>
                        </div>
                        <div class="card-body">
                            <div id="monitorChart" style="height: 300px;"></div>
                            <div class="mt-3">
                                <h6 class="font-weight-bold">数据更新日志</h6>
                                <div id="updateLog" class="small" style="height: 200px; overflow-y: auto;">
                                    <!-- 更新日志将在这里动态显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加数据模态框 -->
<div class="modal fade" id="addItemModal" tabindex="-1" role="dialog" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">添加数据</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="form-group">
                        <label for="symbol">代码</label>
                        <input type="text" class="form-control" id="symbol" name="symbol" required>
                        <small class="form-text text-muted">输入物品代码（如：USD、BTC、GOLD）</small>
                    </div>
                    <div class="form-group">
                        <label for="type">类型</label>
                        <select class="form-control" id="type" name="type" required>
                            <option value="">请选择类型</option>
                            <option value="CURRENCY">货币</option>
                            <option value="CRYPTO">加密货币</option>
                            <option value="COMMODITY">商品</option>
                            <option value="STOCK">股票</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
                <div id="validationResult" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6>验证结果</h6>
                        <div id="validationDetails"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="validateButton">验证</button>
                <button type="button" class="btn btn-success" id="submitButton" style="display: none;">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看数据模态框 -->
<div class="modal fade" id="viewDataModal" tabindex="-1" role="dialog" aria-labelledby="viewDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDataModalLabel">数据详情</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="dataTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="price-tab" data-toggle="tab" href="#price" role="tab">价格数据</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="market-tab" data-toggle="tab" href="#market" role="tab">市场数据</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="svu-tab" data-toggle="tab" href="#svu" role="tab">SVU值</a>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="dataTabContent">
                    <div class="tab-pane fade show active" id="price" role="tabpanel">
                        <div id="priceData"></div>
                    </div>
                    <div class="tab-pane fade" id="market" role="tabpanel">
                        <div id="marketData"></div>
                    </div>
                    <div class="tab-pane fade" id="svu" role="tabpanel">
                        <div id="svuData">
                            <div class="alert alert-info">
                                SVU值计算功能正在开发中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Time Adapter -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
$(document).ready(function() {
    // 初始化DataTable
    const table = $('#itemsTable').DataTable({
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese.json'
        },
        order: [[5, 'desc']], // 按更新时间排序
        pageLength: 25
    });
    
    // 更新价格数据
    function updatePrices() {
        $('.price[data-id]').each(function() {
            const itemId = $(this).data('id');
            $.get(`/api/items/${itemId}/prices`, function(response) {
                if (response && response.length > 0) {
                    const latestPrice = response[0];
                    $(`.price[data-id="${itemId}"]`).text(latestPrice.price.toFixed(2));
                    $(`.update-time[data-id="${itemId}"]`).text(new Date(latestPrice.timestamp).toLocaleString());
                }
            });
        });
    }
    
    // 初始加载价格数据
    updatePrices();
    
    // 定时更新价格数据（每30秒）
    setInterval(updatePrices, 30000);
    
    // 汇率计算
    document.getElementById('exchangeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const amount = document.getElementById('amount').value;
        const fromCurrency = document.getElementById('fromCurrency').value;
        const toCurrencies = Array.from(document.getElementById('toCurrencies').selectedOptions).map(option => option.value);
        
        if (toCurrencies.length === 0) {
            document.getElementById('exchangeResult').innerHTML = `
                <div class="alert alert-warning">
                    请选择至少一个目标货币
                </div>
            `;
            return;
        }
        
        let resultsHtml = '<div class="table-responsive"><table class="table table-bordered">';
        resultsHtml += '<thead><tr><th>目标货币</th><th>汇率</th><th>转换结果</th></tr></thead><tbody>';
        
        for (const toCurrency of toCurrencies) {
            try {
                const response = await fetch(`/api/exchange-rate?from=${fromCurrency}&to=${toCurrency}&amount=${amount}`);
                const data = await response.json();
                
                if (data.success) {
                    const rate = data.data.rate;
                    const result = data.data.result;
                    resultsHtml += `
                        <tr>
                            <td>${toCurrency}</td>
                            <td>1 ${fromCurrency} = ${rate.toFixed(4)} ${toCurrency}</td>
                            <td>${amount} ${fromCurrency} = ${result.toFixed(4)} ${toCurrency}</td>
                        </tr>
                    `;
                } else {
                    resultsHtml += `
                        <tr>
                            <td>${toCurrency}</td>
                            <td colspan="2" class="text-danger">获取汇率失败</td>
                        </tr>
                    `;
                }
            } catch (error) {
                resultsHtml += `
                    <tr>
                        <td>${toCurrency}</td>
                        <td colspan="2" class="text-danger">请求失败</td>
                    </tr>
                `;
            }
        }
        
        resultsHtml += '</tbody></table></div>';
        document.getElementById('exchangeResult').innerHTML = resultsHtml;
    });
    
    // 历史走势图
    let summaryChart = null;
    
    // 全选/取消全选按钮
    $('#selectAll').click(function() {
        $('#chartCurrency option').prop('selected', true);
        updatePriceChart();
    });

    $('#deselectAll').click(function() {
        $('#chartCurrency option').prop('selected', false);
        updatePriceChart();
    });

    async function updatePriceChart() {
        const symbols = $('#chartCurrency').val();
        const baseSymbol = $('#baseCurrency').val();
        const period = $('#chartPeriod').val();
        
        if (!symbols || !baseSymbol) {
            return;
        }
        
        // 确保在创建新图表前销毁旧图表
        if (summaryChart) {
            summaryChart.destroy();
            summaryChart = null;
        }
        
        // 清空统计信息容器
        $('#statsContainer').empty();
        
        // 为每个选中的计价物创建统计信息卡片
        symbols.forEach(symbol => {
            $('#statsContainer').append(`
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-muted">${symbol}</h6>
                            <div class="stats-content" id="stats-${symbol}">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="sr-only">加载中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        });
        
        try {
            // 获取所有选中计价物的数据
            const responses = await Promise.all(
                symbols.map(async symbol => {
                    try {
                        const response = await fetch(`/api/items/${symbol}/price-history?base=${baseSymbol}&period=${period}`);
                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || '获取数据失败');
                        }
                        return data;
                    } catch (error) {
                        console.error(`获取${symbol}数据失败:`, error);
                        throw error;
                    }
                })
            );
            
            const datasets = [];
            const colors = [
                'rgb(75, 192, 192)',
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 206, 86)',
                'rgb(153, 102, 255)',
                'rgb(255, 159, 64)',
                'rgb(201, 203, 207)'
            ];
            
            // 更新统计信息和图表数据
            responses.forEach((response, index) => {
                if (response.success) {
                    const data = response.data;
                    const symbol = symbols[index];
                    
                    // 更新统计信息
                    const statsHtml = `
                        <h4 class="mb-2">${data.stats.current.toFixed(4)}</h4>
                        <div class="d-flex justify-content-between">
                            <span class="text-${data.stats.change_24h >= 0 ? 'success' : 'danger'}">
                                ${data.stats.change_24h.toFixed(2)}%
                            </span>
                            <small class="text-muted">
                                高: ${data.stats.high.toFixed(4)}<br>
                                低: ${data.stats.low.toFixed(4)}
                            </small>
                        </div>
                    `;
                    $(`#stats-${symbol}`).html(statsHtml);
                    
                    // 添加图表数据集
                    datasets.push({
                        label: `${symbol}/${baseSymbol}`,
                        data: data.labels.map((label, i) => ({
                            x: new Date(label),
                            y: data.prices[i]
                        })),
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                        fill: false,
                        tension: 0.4
                    });
                }
            });
            
            if (datasets.length === 0) {
                throw new Error('没有可用的数据');
            }
            
            // 更新汇总图表
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            summaryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `相对价格走势汇总 (基准: ${baseSymbol}, 周期: ${period})`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: period === '1d' ? 'hour' : 
                                      period === '1w' ? 'day' :
                                      period === '1m' ? 'day' :
                                      period === '3m' ? 'week' :
                                      period === '6m' ? 'month' :
                                      'month',
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MM-dd',
                                    week: 'MM-dd',
                                    month: 'yyyy-MM'
                                },
                                tooltipFormat: period === '1d' ? 'MM-dd HH:mm' :
                                             period === '1w' ? 'MM-dd HH:mm' :
                                             period === '1m' ? 'MM-dd' :
                                             period === '3m' ? 'MM-dd' :
                                             period === '6m' ? 'yyyy-MM-dd' :
                                             'yyyy-MM-dd'
                            },
                            ticks: {
                                maxTicksLimit: period === '1d' ? 12 :
                                             period === '1w' ? 7 :
                                             period === '1m' ? 10 :
                                             period === '3m' ? 12 :
                                             period === '6m' ? 6 :
                                             12,
                                maxRotation: 0,
                                autoSkip: true
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(4);
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.4,
                            borderWidth: 2
                        },
                        point: {
                            radius: 1.5,
                            hitRadius: 5,
                            hoverRadius: 4,
                            pointStyle: 'circle'
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        } catch (error) {
            console.error('获取历史价格数据失败:', error);
            $('#statsContainer').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">获取历史价格数据失败</h5>
                        <p class="mb-0">${error.message}</p>
                    </div>
                </div>
            `);
        }
    }
    
    // 监听图表选项的变化
    $('#chartCurrency, #baseCurrency, #chartPeriod').on('change', updatePriceChart);
    
    // 刷新按钮点击事件
    $('#refreshData').click(function() {
        updatePrices();
        addLog('手动刷新数据');
    });
    
    // 更新日志
    function addLog(message) {
        const time = new Date().toLocaleString();
        $('#updateLog').prepend(`<div>[${time}] ${message}</div>`);
    }
    
    // 验证按钮点击事件
    $('#validateButton').click(function() {
        const symbol = $('#symbol').val().trim().toUpperCase();
        const type = $('#type').val();
        
        if (!symbol || !type) {
            alert('请填写代码和类型');
            return;
        }
        
        // 显示加载状态
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 验证中...');
        
        // 发送验证请求
        $.ajax({
            url: '/api/validate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ symbol, type }),
            success: function(response) {
                if (response.is_valid) {
                    // 显示验证结果
                    $('#validationResult').show();
                    $('#validationDetails').html(`
                        <p><strong>名称：</strong>${response.data.name}</p>
                        <p><strong>市场类型：</strong>${response.data.market_type}</p>
                        <p><strong>价格：</strong>${response.data.price || 'N/A'}</p>
                        <p><strong>更新时间：</strong>${new Date().toLocaleString()}</p>
                    `);
                    
                    // 显示提交按钮
                    $('#submitButton').show();
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || ['验证失败'];
                $('#validationResult').show();
                $('#validationDetails').html(`
                    <div class="alert alert-danger">
                        ${error.join('<br>')}
                    </div>
                `);
            },
            complete: function() {
                // 恢复按钮状态
                $('#validateButton').prop('disabled', false).text('验证');
            }
        });
    });
    
    // 提交按钮点击事件
    $('#submitButton').click(function() {
        const formData = {
            symbol: $('#symbol').val().trim().toUpperCase(),
            type: $('#type').val(),
            description: $('#description').val()
        };
        
        // 显示加载状态
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 添加中...');
        
        // 发送添加请求
        $.ajax({
            url: '/api/items',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                // 关闭模态框
                $('#addItemModal').modal('hide');
                
                // 刷新页面
                location.reload();
                
                // 添加日志
                addLog(`添加新数据：${response.name} (${response.symbol})`);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || ['添加失败'];
                alert(error.join('\n'));
                
                // 恢复按钮状态
                $('#submitButton').prop('disabled', false).text('添加');
            }
        });
    });
    
    // 查看数据按钮点击事件
    $('.view-data').click(function() {
        const itemId = $(this).data('id');
        
        // 获取价格数据
        $.get(`/api/items/${itemId}/prices`, function(response) {
            let priceHtml = '<div class="table-responsive"><table class="table table-sm">';
            priceHtml += '<thead><tr><th>价格</th><th>时间</th><th>来源</th></tr></thead><tbody>';
            
            response.forEach(price => {
                priceHtml += `<tr>
                    <td>${price.price}</td>
                    <td>${new Date(price.timestamp).toLocaleString()}</td>
                    <td>${price.source}</td>
                </tr>`;
            });
            
            priceHtml += '</tbody></table></div>';
            $('#priceData').html(priceHtml);
        });
        
        // 获取市场数据
        $.get(`/api/items/${itemId}/market-data`, function(response) {
            let marketHtml = '<div class="table-responsive"><table class="table table-sm">';
            marketHtml += '<tbody>';
            
            for (const [key, value] of Object.entries(response)) {
                marketHtml += `<tr>
                    <th>${key}</th>
                    <td>${value}</td>
                </tr>`;
            }
            
            marketHtml += '</tbody></table></div>';
            $('#marketData').html(marketHtml);
        });
        
        // 显示模态框
        $('#viewDataModal').modal('show');
    });
    
    // 更新价格按钮点击事件
    $('.update-price').click(function() {
        const itemId = $(this).data('id');
        const button = $(this);
        
        // 显示加载状态
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
        
        // 发送更新请求
        $.ajax({
            url: `/api/items/${itemId}/update-price`,
            method: 'POST',
            success: function(response) {
                // 更新价格显示
                $(`.price[data-id="${itemId}"]`).text(response.price.toFixed(2));
                $(`.update-time[data-id="${itemId}"]`).text(new Date().toLocaleString());
                
                // 添加日志
                addLog(`更新价格：${response.name} (${response.symbol}) - ${response.price}`);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || ['更新失败'];
                alert(error.join('\n'));
            },
            complete: function() {
                // 恢复按钮状态
                button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i>');
            }
        });
    });
    
    // 删除按钮点击事件
    $('.delete-item').click(function() {
        if (!confirm('确定要删除这个物品吗？')) {
            return;
        }
        
        const itemId = $(this).data('id');
        const button = $(this);
        
        // 显示加载状态
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
        
        // 发送删除请求
        $.ajax({
            url: `/api/items/${itemId}`,
            method: 'DELETE',
            success: function() {
                // 从表格中移除行
                table.row(button.closest('tr')).remove().draw();
                
                // 添加日志
                addLog(`删除数据：ID ${itemId}`);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || ['删除失败'];
                alert(error.join('\n'));
                
                // 恢复按钮状态
                button.prop('disabled', false).html('<i class="fas fa-trash"></i>');
            }
        });
    });
    
    // 重置模态框
    $('#addItemModal').on('hidden.bs.modal', function() {
        $('#addItemForm')[0].reset();
        $('#validationResult').hide();
        $('#validationDetails').empty();
        $('#submitButton').hide();
    });
});
</script>
{% endblock %} 
